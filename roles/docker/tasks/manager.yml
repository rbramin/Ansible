---
- name: Add Docker CE repository
  get_url:
    url: https://download.docker.com/linux/rhel/docker-ce.repo
    dest: /etc/yum.repos.d/docker-ce.repo

- name: Install Docker packages
  package:
    name: "{{ docker_packages }}"
    state: present

- name: Enable Docker
  service:
    name: docker
    enabled: yes
    state: started

- name: Check if node already in a swarm
  command: docker info -f '{{ "{{.Swarm.LocalNodeState}}" }}'
  register: swarm_state
  changed_when: false

- name: Initialize Docker Swarm
  command: docker swarm init --advertise-addr {{ ansible_host }}
  when: swarm_state.stdout != "active"

- name: Get worker join token
  command: docker swarm join-token -q worker
  register: worker_token
  when: docker_swarm_init | default(false)

- set_fact:
    swarm_worker_token: "{{ worker_token.stdout }}"
  when: docker_swarm_init | default(false)

- name: Create directory for Docker build context
  file:
    path: /opt/app
    state: directory
    owner: ansible
    mode: '0755'

- name: Copy Dockerfile
  copy:
    src: Dockerfile
    dest: /opt/app/Dockerfile

- name: Build docker image
  command: docker build -t labapp:1.0 /opt/app
  args:
    chdir: /opt/app
  run_once: true

- name: Deploy stack on Docker Swarm
  command: docker service create --name labapp --replicas 3 -p 8080:80 labapp:1.0
  run_once: true
